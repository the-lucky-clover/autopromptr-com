
name = "autopromptr-worker"
main = "src/index.ts"
compatibility_date = "2024-01-15"
node_compat = true

# Durable Objects Configuration (FREE TIER)
[[durable_objects.bindings]]
name = "BATCH_QUEUE"
class_name = "BatchQueue"
script_name = "autopromptr-worker"

# Migrations for Durable Objects
[[migrations]]
tag = "v1"
new_classes = ["BatchQueue"]

# D1 Database (FREE TIER - 5GB storage, 5M reads/day, 100K writes/day)
[[d1_databases]]
binding = "AUTOPROMPTR_DB"
database_name = "autopromptr"
database_id = "" # Will be created: wrangler d1 create autopromptr

# KV Namespace (FREE TIER - 100K reads/day, 1K writes/day, 1GB storage)
[[kv_namespaces]]
binding = "AUTOPROMPTR_KV"
id = "" # Will be created: wrangler kv:namespace create "AUTOPROMPTR_KV"

# R2 Storage (FREE TIER - 10GB storage, 1M Class A operations/month)
[[r2_buckets]]
binding = "AUTOPROMPTR_STORAGE"
bucket_name = "autopromptr-files"

# Browser Rendering API binding (PAID - disabled for free tier)
# [[browser]]
# binding = "BROWSER"

# Environment Variables
# Set these via: wrangler secret put <KEY>
[vars]
ENVIRONMENT = "production"
SITE_URL = "https://autopromptr.pages.dev"
EMAIL_FROM = "noreply@autopromptr.com"
EMAIL_FROM_NAME = "AutoPromptr"

# Secrets (set via wrangler secret put):
# - JWT_SECRET: Secret key for JWT signing (required for auth)
# - RESEND_API_KEY: API key for Resend email service (optional - falls back to MailChannels)
# 
# Email Configuration (optional - MailChannels is free for Cloudflare Workers):
# - DKIM_DOMAIN: Your domain for DKIM signing (e.g., autopromptr.com)
# - DKIM_SELECTOR: DKIM selector (e.g., mailchannels)
# - DKIM_PRIVATE_KEY: Your DKIM private key (base64 encoded)
#
# For MailChannels (FREE), add this SPF record to your DNS:
# Type: TXT, Name: @, Value: v=spf1 a mx include:relay.mailchannels.net ~all
#
# For domain lockdown (recommended), add this TXT record:
# Type: TXT, Name: _mailchannels, Value: v=mc1 cfid=your-worker-subdomain.workers.dev

# Production Environment
[env.production]
name = "autopromptr-worker"
vars = { ENVIRONMENT = "production", SITE_URL = "https://autopromptr.pages.dev" }

[[env.production.durable_objects.bindings]]
name = "BATCH_QUEUE"
class_name = "BatchQueue"
script_name = "autopromptr-worker"

[[env.production.d1_databases]]
binding = "AUTOPROMPTR_DB"
database_name = "autopromptr-production"
database_id = "" # Create with: wrangler d1 create autopromptr-production

[[env.production.kv_namespaces]]
binding = "AUTOPROMPTR_KV"
id = "" # Create with: wrangler kv:namespace create "AUTOPROMPTR_KV" --env production

[[env.production.r2_buckets]]
binding = "AUTOPROMPTR_STORAGE"
bucket_name = "autopromptr-files"

# Preview/Staging Environment
[env.preview]
name = "autopromptr-worker-preview"
vars = { ENVIRONMENT = "preview" }

[[env.preview.durable_objects.bindings]]
name = "BATCH_QUEUE"
class_name = "BatchQueue"
script_name = "autopromptr-worker-preview"

[[env.preview.d1_databases]]
binding = "AUTOPROMPTR_DB"
database_name = "autopromptr-preview"
database_id = "" # Create with: wrangler d1 create autopromptr-preview

[[env.preview.kv_namespaces]]
binding = "AUTOPROMPTR_KV"
id = "" # Create with: wrangler kv:namespace create "AUTOPROMPTR_KV" --env preview

[[env.preview.r2_buckets]]
binding = "AUTOPROMPTR_STORAGE"
bucket_name = "autopromptr-files-preview"

# Secrets (set via CLI or dashboard):
# wrangler secret put SUPABASE_URL
# wrangler secret put SUPABASE_ANON_KEY
# wrangler secret put SUPABASE_SERVICE_ROLE_KEY
